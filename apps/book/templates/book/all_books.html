{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tous les livres - ArtCollab</title>
    <link rel="icon" type="image/png" href="{% static 'assets/img/favicon/homework.png' %}">
    <link rel="stylesheet" href="{% static 'assets/css/volt.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/books-custom.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="books-page">
    {% include 'includes/header.html' %}
    <br><br>

    <!-- Hero Section -->
    <section class="books-hero">
        <div class="container text-center">
            <div class="book-icon-hero mb-4 glow">
                <i class="fas fa-book-open"></i>
            </div>
            <h1 class="mb-3">Tous les <span class="gradient-text">Livres</span></h1>
            <p class="lead">Découvrez l’ensemble des livres publiés sur la plateforme</p>
        </div>
    </section>

    <!-- Books Container -->
    <section class="books-container">
        <div class="container">

            {% if books %}
            <div class="row">
                {% for book in books %}
                <div class="col-md-6 col-lg-4" style="--animation-order: {{ forloop.counter }};">
                    <div class="book-card">
                            <div class="book-card-header d-flex justify-content-between align-items-center">
                                <h3 class="book-card-title mb-0 flex-grow-1">
                                    <i class="fas fa-book me-2"></i> {{ book.title }}
                                </h3>
                                <!-- Icônes panier et favoris -->
                                {% if request.user.id != book.author_id %}
                                    <div class="d-flex align-items-center gap-2 ms-2">
                                        <i class="fas fa-shopping-cart text-primary" 
                                        style="cursor:pointer; font-size: 1.1rem; padding: 8px;" 
                                        title="Ajouter au panier"
                                        onclick="addToCart({{ book.id }})"></i>

                                        <i id="heart-{{ book.id }}" class="fas fa-heart text-secondary"
                                        style="cursor:pointer; font-size: 1.1rem; padding: 8px;"
                                        title="Ajouter aux favoris"
                                        onclick="toggleFavorite({{ book.id }})"></i>
                                    </div>
                                {% endif %}

                            </div>
                        <div class="book-card-body">
                            <div class="book-meta">
                                <i class="fas fa-user"></i>
                                <strong class="me-1">Auteur:</strong>
                                {{ book.author.get_full_name|default:book.author.username }}
                            </div>
                            <div class="book-meta">
                                <i class="fas fa-tag"></i>
                                <strong class="me-1">Genre:</strong> {{ book.genre }}
                            </div>
                            <div class="book-meta">
                                <i class="fas fa-info-circle"></i>
                                <strong class="me-1">Statut:</strong>
                                <span class="book-status 
                                    {% if book.status == 'en_cours' %}status-en-cours
                                    {% elif book.status == 'termine' %}status-termine
                                    {% else %}status-archive{% endif %}">
                                    {% if book.status == 'en_cours' %}
                                        <i class="fas fa-spinner me-1"></i> En cours
                                    {% elif book.status == 'termine' %}
                                        <i class="fas fa-check me-1"></i> Terminé
                                    {% else %}
                                        <i class="fas fa-archive me-1"></i> Archivé
                                    {% endif %}
                                </span>
                            </div>
                              <div class="book-meta">
                                {% if book.price == 0 %}

                                <i class="fas fa-gift"></i>
                                <strong class="me-1">Prix:</strong> <span class="text-success">Gratuit</span>
                                {% else %}
                                <i class="fas fa-euro-sign"></i>
                                <strong class="me-1">Prix:</strong> {{ book.price|floatformat:2 }} €
                                {% endif %}
                            </div>
                            {% if book.synopsis %}
                            <div class="book-meta mt-3">
                                <i class="fas fa-align-left"></i>
                                <strong class="me-1">Synopsis:</strong>
                            </div>
                            <p class="text-muted small" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                {{ book.synopsis|truncatewords:20 }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state text-center">
                <div class="empty-icon"><i class="fas fa-book-reader"></i></div>
                <h3>Aucun livre trouvé</h3>
                <p>Revenez plus tard pour découvrir de nouveaux livres.</p>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Bootstrap -->
    <script src="{% static 'assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        const addToCart = (bookId) => {
            fetch(`/cart/add/${bookId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Livre ajouté au panier !');
                } else {
                    alert('Erreur lors de l\'ajout au panier.');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        };
        // Animation fade-in
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, { threshold: 0.1 });
        const addToFavorites = (bookId) => {
    fetch(`/books/favorites/add/${bookId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            alert('Livre ajouté aux favoris !');
        } else {
            alert('Erreur lors de l\'ajout aux favoris.');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
    });
};

      async function checkFavourite(bookId) {
    try {
        const response = await fetch(`/books/favorites/check/${bookId}/`);
        const data = await response.json();
        return data.is_favorite; // true / false
    } catch (error) {
        console.error('Erreur:', error);
        return false;
    }
}

        document.querySelectorAll('.book-card').forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(card);
        });
        async function updateHeartIcon(bookId) {
    const isFav = await checkFavourite(bookId);
    const heart = document.getElementById(`heart-${bookId}`);
    
    if (isFav) {
        heart.classList.add('text-danger'); // rouge si favori
        heart.classList.remove('text-secondary');
        heart.title = "Retirer des favoris";
    } else {
        heart.classList.add('text-secondary'); // gris si non favori
        heart.classList.remove('text-danger');
        heart.title = "Ajouter aux favoris";
    }
}

async function toggleFavorite(bookId) {
    const isFav = await checkFavourite(bookId);
    const url = isFav ? `/books/favorites/remove/${bookId}/` : `/books/favorites/add/${bookId}/`;

    await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    });

    updateHeartIcon(bookId);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
document.addEventListener("DOMContentLoaded", async () => {
    // Quand la page est entièrement chargée, on met à jour chaque cœur
    const hearts = document.querySelectorAll('[id^="heart-"]');
    for (const heart of hearts) {
        const bookId = heart.id.split('-')[1];
        await updateHeartIcon(bookId);
    }
});

    </script>
</body>
</html>
