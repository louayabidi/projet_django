<p>cd apps/badge/templates/badge/t<span style="color: rgb(197, 134, 192);">from</span> <span style="color: rgb(78, 201, 176);">django</span>.<span style="color: rgb(78, 201, 176);">shortcuts</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(220, 220, 170);">render</span>, <span style="color: rgb(220, 220, 170);">redirect</span>, <span style="color: rgb(220, 220, 170);">get_object_or_404</span></p><p><span style="color: rgb(197, 134, 192);">from</span> <span style="color: rgb(78, 201, 176);">django</span>.<span style="color: rgb(78, 201, 176);">contrib</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(78, 201, 176);">messages</span></p><p><span style="color: rgb(197, 134, 192);">from</span> <span style="color: rgb(78, 201, 176);">django</span>.<span style="color: rgb(78, 201, 176);">contrib</span>.<span style="color: rgb(78, 201, 176);">auth</span>.<span style="color: rgb(78, 201, 176);">decorators</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(220, 220, 170);">login_required</span></p><p><span style="color: rgb(197, 134, 192);">from</span> <span style="color: rgb(78, 201, 176);">django</span>.<span style="color: rgb(78, 201, 176);">http</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(78, 201, 176);">JsonResponse</span></p><p><span style="color: rgb(197, 134, 192);">from</span> .<span style="color: rgb(78, 201, 176);">models</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(78, 201, 176);">Badge</span>, <span style="color: rgb(78, 201, 176);">UserBadge</span></p><p><span style="color: rgb(197, 134, 192);">from</span> .<span style="color: rgb(78, 201, 176);">forms</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(78, 201, 176);">BadgeForm</span></p><p><span style="color: rgb(197, 134, 192);">from</span> .<span style="color: rgb(78, 201, 176);">services</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(78, 201, 176);">BadgeService</span></p><p><br></p><p><span style="color: rgb(220, 220, 170);">@login_required</span></p><p><span style="color: rgb(86, 156, 214);">def</span> <span style="color: rgb(220, 220, 170);">badge_list</span>(<span style="color: rgb(156, 220, 254);">request</span>):</p><p>&nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">if</span> <span style="color: rgb(86, 156, 214);">not</span> <span style="color: rgb(156, 220, 254);">request</span>.user.is_authenticated <span style="color: rgb(86, 156, 214);">or</span> <span style="color: rgb(86, 156, 214);">not</span> <span style="color: rgb(220, 220, 170);">hasattr</span>(<span style="color: rgb(156, 220, 254);">request</span>.user, <span style="color: rgb(206, 145, 120);">'role'</span>) <span style="color: rgb(86, 156, 214);">or</span> <span style="color: rgb(156, 220, 254);">request</span>.user.role <span style="color: rgb(212, 212, 212);">!=</span> <span style="color: rgb(206, 145, 120);">'admin'</span>:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(78, 201, 176);">messages</span>.<span style="color: rgb(220, 220, 170);">error</span>(<span style="color: rgb(156, 220, 254);">request</span>, <span style="color: rgb(206, 145, 120);">"Accès refusé."</span>)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">return</span> <span style="color: rgb(220, 220, 170);">redirect</span>(<span style="color: rgb(206, 145, 120);">'badge:your_badges'</span>)</p><p><br></p><p>&nbsp; &nbsp; <span style="color: rgb(156, 220, 254);">badges</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(78, 201, 176);">Badge</span>.<span style="color: rgb(156, 220, 254);">objects</span>.<span style="color: rgb(220, 220, 170);">all</span>().<span style="color: rgb(220, 220, 170);">order_by</span>(<span style="color: rgb(206, 145, 120);">'-date_creation'</span>) &nbsp;<span style="color: rgb(106, 153, 85);"># Tri récent</span></p><p><br></p><p>&nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">return</span> <span style="color: rgb(220, 220, 170);">render</span>(<span style="color: rgb(156, 220, 254);">request</span>, <span style="color: rgb(206, 145, 120);">'badge/badge_list.html'</span>, {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(206, 145, 120);">'badges'</span>: <span style="color: rgb(156, 220, 254);">badges</span>,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(206, 145, 120);">'title'</span>: <span style="color: rgb(206, 145, 120);">'Gestion des Badges'</span>,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(206, 145, 120);">'segment'</span>: <span style="color: rgb(206, 145, 120);">'badge_list'</span> &nbsp;<span style="color: rgb(106, 153, 85);"># Pour activer le lien dans la sidebar</span></p><p>&nbsp; &nbsp; })</p><p><br></p><p><span style="color: rgb(220, 220, 170);">@login_required</span></p><p><span style="color: rgb(86, 156, 214);">def</span> <span style="color: rgb(220, 220, 170);">badge_create</span>(<span style="color: rgb(156, 220, 254);">request</span>):</p><p>&nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">if</span> <span style="color: rgb(86, 156, 214);">not</span> (<span style="color: rgb(220, 220, 170);">hasattr</span>(<span style="color: rgb(156, 220, 254);">request</span>.user, <span style="color: rgb(206, 145, 120);">'role'</span>) <span style="color: rgb(86, 156, 214);">and</span> <span style="color: rgb(156, 220, 254);">request</span>.user.role <span style="color: rgb(212, 212, 212);">==</span> <span style="color: rgb(206, 145, 120);">'admin'</span>):</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(78, 201, 176);">messages</span>.<span style="color: rgb(220, 220, 170);">error</span>(<span style="color: rgb(156, 220, 254);">request</span>, <span style="color: rgb(206, 145, 120);">"Vous n'avez pas la permission de créer des badges."</span>)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">return</span> <span style="color: rgb(220, 220, 170);">redirect</span>(<span style="color: rgb(206, 145, 120);">'badge:badge_list'</span>)</p><p>&nbsp; &nbsp; </p><p>&nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">if</span> <span style="color: rgb(156, 220, 254);">request</span>.method <span style="color: rgb(212, 212, 212);">==</span> <span style="color: rgb(206, 145, 120);">'POST'</span>:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(156, 220, 254);">form</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(78, 201, 176);">BadgeForm</span>(<span style="color: rgb(156, 220, 254);">request</span>.POST, <span style="color: rgb(156, 220, 254);">request</span>.FILES)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">if</span> <span style="color: rgb(156, 220, 254);">form</span>.<span style="color: rgb(220, 220, 170);">is_valid</span>():</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(156, 220, 254);">badge</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(156, 220, 254);">form</span>.<span style="color: rgb(220, 220, 170);">save</span>()</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(106, 153, 85);"># DEBUG : affiche l'objet badge</span></p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(220, 220, 170);">print</span>(<span style="color: rgb(206, 145, 120);">"BADGE CRÉÉ → ID:"</span>, <span style="color: rgb(156, 220, 254);">badge</span>.<span style="color: rgb(220, 220, 170);">id</span>, <span style="color: rgb(206, 145, 120);">"| NOM:"</span>, <span style="color: rgb(156, 220, 254);">badge</span>.nom, <span style="color: rgb(206, 145, 120);">"| IMAGE:"</span>, <span style="color: rgb(156, 220, 254);">badge</span>.image)</p><p><br></p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(106, 153, 85);"># Initialiser pour tous les utilisateurs</span></p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">from</span> <span style="color: rgb(78, 201, 176);">django</span>.<span style="color: rgb(78, 201, 176);">contrib</span>.<span style="color: rgb(78, 201, 176);">auth</span> <span style="color: rgb(197, 134, 192);">import</span> <span style="color: rgb(220, 220, 170);">get_user_model</span></p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(78, 201, 176);">User</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(220, 220, 170);">get_user_model</span>()</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">for</span> <span style="color: rgb(156, 220, 254);">user</span> <span style="color: rgb(220, 220, 170);">in</span> <span style="color: rgb(78, 201, 176);">User</span>.<span style="color: rgb(156, 220, 254);">objects</span>.<span style="color: rgb(220, 220, 170);">all</span>():</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(78, 201, 176);">UserBadge</span>.<span style="color: rgb(156, 220, 254);">objects</span>.<span style="color: rgb(220, 220, 170);">get_or_create</span>(<span style="color: rgb(156, 220, 254);">user</span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(156, 220, 254);">user</span>, <span style="color: rgb(156, 220, 254);">badge</span><span style="color: rgb(212, 212, 212);">=</span><span style="color: rgb(156, 220, 254);">badge</span>)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(78, 201, 176);">messages</span>.<span style="color: rgb(220, 220, 170);">success</span>(<span style="color: rgb(156, 220, 254);">request</span>, <span style="color: rgb(86, 156, 214);">f</span><span style="color: rgb(206, 145, 120);">'Le badge "</span><span style="color: rgb(86, 156, 214);">{</span><span style="color: rgb(156, 220, 254);">badge</span>.nom<span style="color: rgb(86, 156, 214);">}</span><span style="color: rgb(206, 145, 120);">" a été créé avec succès!'</span>)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">return</span> <span style="color: rgb(220, 220, 170);">redirect</span>(<span style="color: rgb(206, 145, 120);">'badge:badge_list'</span>)</p><p>&nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">else</span>:</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(156, 220, 254);">form</span> <span style="color: rgb(212, 212, 212);">=</span> <span style="color: rgb(78, 201, 176);">BadgeForm</span>()</p><p>&nbsp; &nbsp; </p><p>&nbsp; &nbsp; <span style="color: rgb(197, 134, 192);">return</span> <span style="color: rgb(220, 220, 170);">render</span>(<span style="color: rgb(156, 220, 254);">request</span>, <span style="color: rgb(206, 145, 120);">'badge/badge_form.html'</span>, {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(206, 145, 120);">'form'</span>: <span style="color: rgb(156, 220, 254);">form</span>,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(206, 145, 120);">'title'</span>: <span style="color: rgb(206, 145, 120);">'Créer un badge'</span>,</p>